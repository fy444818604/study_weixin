var $=require("../jquery"),STATUS_NONE=0,STATUS_OPEN=1,STATUS_ERROR=2,STATUS_CLOSE=3,STATUS_TIMEOUT=4,STATUS_CONNECTING=5,noop=function(){};function WebSocket(o){$.extend(this,o),this.status=STATUS_NONE,0<o.retryCount&&(this.retryIndex=0)}var proto=WebSocket.prototype;proto.isOpen=function(){return this.status===STATUS_OPEN},proto.isConnecting=function(){return this.status===STATUS_CONNECTING},proto.connect=function(o,t){var r=this;if(r.status!==STATUS_OPEN&&r.status!==STATUS_CONNECTING){var T=[o];t&&t.length&&(T=T.concat(t));var S=-1,e=function(){var t,e,n,s,o;r.status===STATUS_CONNECTING&&(t=T[++S],e=function(o,t,e){if(r.status===STATUS_CONNECTING)if(e===STATUS_OPEN)r.url=t.url,r.socket=o,r.status=STATUS_OPEN,o.onMessage(function(o){r.status===STATUS_OPEN&&r.onReceive(JSON.parse(o.data))}),o.onClose(function(){console.log("socket closed"+r.url),console.log(arguments),r.onClose&&r.onClose(),r.socket=null,r.status=STATUS_CLOSE}),0<r.retryCount&&(r.retryIndex=0),r.onOpen&&r.onOpen({server:t});else if(S===T.length-1){if(0<r.retryCount&&r.retryIndex++<r.retryCount)return S=-1,void u();switch(r.status=e){case STATUS_ERROR:r.onError&&r.onError();break;case STATUS_TIMEOUT:r.onTimeout&&r.onTimeout()}}else u()},s=wx.connectSocket({url:t.url}),o=function(o){n&&clearTimeout(n),s.onOpen(noop),s.onError(noop),e(s,t,o)},s.onOpen(function(){o(STATUS_OPEN)}),s.onError(function(){console.log("socket error"),console.log(arguments),o(STATUS_ERROR)}),0<r.timeout&&(n=setTimeout(function(){n=null,o(STATUS_TIMEOUT)},r.timeout)))},u=function(){0<r.interval?setTimeout(e,r.interval):e()};r.status=STATUS_CONNECTING,e()}},proto.send=function(o){var t=this.socket;t&&(t.send({data:"string"==typeof o?o:JSON.stringify(o)}),this.onSend&&this.onSend(o))},proto.close=function(){var o=this,t=$.Deferred(),e=this.socket;return this.socket=null,this.status=STATUS_CLOSE,e?(e.onMessage(noop),e.onClose(noop),e.close({code:1,reason:"close by client"}),e.onClose(function(){o.onClose&&o.onClose(),t.resolve()})):t.resolve(),t},module.exports=WebSocket;